{"componentChunkName":"component---src-templates-post-js","path":"/terraform-azure-service-principal/","result":{"data":{"markdownRemark":{"html":"<p>In order to use the Azure provider with Terraform (and hence allow Terraform to create/alter/delete your environments) one approach is to set up a service principal and use that to authenticate via a client secret.</p>\n<p>You can set up your principal either by command line or the Azure portal. I'll be covering the Azure portal approach as it's pretty straight forward.</p>\n<ol>\n<li>Log in to the portal (<a href=\"https://portal.azure.com\">portal.azure.com</a>) and click on \"Azure Active Directory\".\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; margin:0; max-width: 270px;\"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 217.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Azure AD App registrations\"\n        title=\"Azure AD App registrations\"\n        src=\"/static/f2522eb5bd82b337d16963856c02e1fd/4ca17/azure-ad-app-registration.png\"\n        srcset=\"/static/f2522eb5bd82b337d16963856c02e1fd/2b3f6/azure-ad-app-registration.png 230w,\n/static/f2522eb5bd82b337d16963856c02e1fd/4ca17/azure-ad-app-registration.png 270w\"\n        sizes=\"(max-width: 270px) 100vw, 270px\"\n        loading=\"lazy\"\n      />\n    </span></li>\n<li>Click on  \"+ New Registration\" and give it a meaningful name like \"TerraformServicePrinciple\". Leave \"Supported account types\" as is and set any Redirect URI with Web in the dropdown (e.g. <a href=\"https://terra.form\">https://terra.form</a>).</li>\n<li>Click \"Register\" button down the bottom and then select it from the All applications list.</li>\n<li>At this point take note of a couple of things you'll need later, the client ID and the tenant ID as below. Then click on \"Certificates &#x26; secrets\".\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; margin:0; max-width: 588px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bf2c696402f379572f7c0a80b860c23d/4214e/azure-ad-app-registration-details.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.85714285714286%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACo0lEQVQ4y32T228aVxCH9yGvfa4i5f+z2kpN0vYhUmupTfKfJH2wqGXXAht8k+MgHIiJwReEXAzBwGLY+5WLd/ly9hhbdZJ2pE8z5+ye3+ycmVWUJ2W+Wazy6OUJ3z4/4eGLE5SfP6A8LqP8eMiDZxUWUi2+/6spaPFdqskPy615fMHCUkP6p3+3+Wmtg/Jbps3LXIfnuS6/Z7v8Ifzieodn6Ut+WWvza+aSpfc9/sxf8OptQ/rXc5bLKitHV5K16kCi1FSbqW+iDfqY2gBTHxLYOsbwZh24NsymXIcu04TAvYkDR+5DLIjuUHYvHFzXYzDUGGqa9Lf0r66wbIcZX7coTpjdQ4mnI3w/IAgCRuMxcRyLB7H019fXzGYzDH+MZeh44ZiuFcrY97257OweysCw0LUhhq7jOja+50o8Qei7dPQpS6URhw2X47bPh6ZHpelS/ehx0g4EvuRYrKstD6X+sUu33ULtdXBsE9s0sK0bHFNDNUa8qfmctSzqbYtmP5A01IDznsc/El/GDdVH8T0Py7KwbfuLO0rKTQimEfY4xhM9mIj9IOY/TbFMU97drcC/xRKbiETFgxJ7+QKFdyWK78ucX7S47HSo1WpcicbF88QJSk/coSsOTSYTuRFFEbEg8Ynk2HHY2dwknU6T3dhgfT1DJpNmQ8RbW1vU63XZwDvBphOiD4fohsk0iu59ocwchvR7KutCIBFNpVKsrK6SzWbZ39+X15V8zO0ZZVg9RDuq0C+XMUW2kaoSGYaY15uskUDt9zk4OKBYLMoyK5UKhUKBnZ0dzs7OZDV3guNKAb1yjCEErVIJTbw0Ep55CckshmJGT09P2d7eJpfLsbu7Sz6fZ29vT4rfE3TCEUljdDGH1medlmXH/9PSucXzHyHhE0GG/fMtjZw0AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Azure AD App registration details\"\n        title=\"Azure AD App registration details\"\n        src=\"/static/bf2c696402f379572f7c0a80b860c23d/4214e/azure-ad-app-registration-details.png\"\n        srcset=\"/static/bf2c696402f379572f7c0a80b860c23d/2b3f6/azure-ad-app-registration-details.png 230w,\n/static/bf2c696402f379572f7c0a80b860c23d/a9ee3/azure-ad-app-registration-details.png 460w,\n/static/bf2c696402f379572f7c0a80b860c23d/4214e/azure-ad-app-registration-details.png 588w\"\n        sizes=\"(max-width: 588px) 100vw, 588px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></li>\n<li>Now we create a Client Secret by clicking into \"Certificates &#x26; secrets\" and then \"+ New client secret\".</li>\n<li>Give it a meaningful description / name and pick an expiry date (I'd go with one year for better security in case you accidentally expose the secret somewhere).</li>\n<li>Take note of the client secret and put it somewhere safe like a password vault / manager as you can't retrieve it again (although you can always generate a new secret).</li>\n</ol>\n<p>At this point you've got your service principal and some credentials however you need to grant it permissions to modify resources in your subscription.</p>\n<ol>\n<li>Go to the \"Subscriptions\" blade in the portal and choose your subscription (assuming you've got more than one).</li>\n<li>In the overview taken note of your \"Subscription ID\", this is the final bit of info you need when running Terraform.</li>\n<li>Click on \"Access control (IAM)\" and then \"Add a role assignment\".</li>\n<li>Choose a Role, in most cases you'll need \"Contributor\" for Read/Write on all resources in the Subscription although you may want to drop this down to a lesser role for security later (e.g. Website Contributor).</li>\n<li>Search for your Service Principal and then Save.</li>\n</ol>\n<p>Now you're set to use this Principal when you set up your provider in Terraform.</p>\n<p>I usually create an \"environment\" folder at the root of the repository and then perhaps folders for dev, test, prod etc. You might even have folders per cloud provider if you're using multi-cloud resources. Add a <code class=\"language-text\">provider.tf</code> file with the following content.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">variable<span class=\"token type variable\"> \"client_secret\" </span></span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">provider<span class=\"token type variable\"> \"azurerm\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">version</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"~> 1.36\"</span>\n  <span class=\"token property\">subscription_id</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"00000000-0000-0000-0000-000000000000\"</span>\n  <span class=\"token property\">client_id</span>                   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"00000000-0000-0000-0000-000000000000\"</span>\n  <span class=\"token property\">client_secret</span>               <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">client_secret</span><span class=\"token punctuation\">}</span></span>\"</span>\n  <span class=\"token property\">tenant_id</span>                   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"00000000-0000-0000-0000-000000000000\"</span>\n  <span class=\"token property\">skip_provider_registration</span>  <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The <code class=\"language-text\">skip_provider_registration</code> bit is optional and more if you're a bit pedantic like me. Essentially you're telling Terraform to skip registering a bunch of Resource providers. It tends to do as many as it can whereas you might only be creating a small subset of resources. Although it does mean you have to do the registrations manually which can be annoying and tedious (as well as giving less meaningful error messages). More <a href=\"https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-manager-register-provider-errors\">details provided here</a>.</p>\n<p>At this point you should be able to initialise Terraform with <code class=\"language-text\">terraform init</code>.</p>\n<p>Terraform also provide a <a href=\"https://www.terraform.io/docs/providers/azurerm/auth/service_principal_client_secret.html\">detailed explanation</a> and how to do this process using the Azure CLI.</p>","frontmatter":{"date":"October 29, 2019","path":"/terraform-azure-service-principal/","title":"Azure service principle for use with Terraform"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}